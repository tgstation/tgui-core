name: Announce PR on Discord

on:
  pull_request:
    types: [opened]

jobs:
  announce:
    runs-on: ubuntu-latest
    steps:
      - name: Announce new PR to Discord
        shell: bash
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          PR_URL: ${{ github.event.pull_request.html_url }}
        run: |
          set -euo pipefail

          payload=$(python3 - <<'PY'
          import json
          import os

          pr_number = os.environ["PR_NUMBER"]
          pr_title = os.environ["PR_TITLE"]
          pr_author = os.environ["PR_AUTHOR"]
          pr_url = os.environ["PR_URL"]

          content = f"New PR #{pr_number} *opened* by {pr_author}: **{pr_title}**"
          body = {
              "content": content,
              "embeds": [
                  {
                      "description": f"[View Pull Request]({pr_url})",
                      "color": 10738085,
                      "fields": [
                          {"name": "Author", "value": pr_author, "inline": True},
                      ],
                  }
              ],
          }

          print(json.dumps(body, ensure_ascii=False))
          PY
          )

          curl -H "Content-Type: application/json" -X POST --data "$payload" "$DISCORD_WEBHOOK"
