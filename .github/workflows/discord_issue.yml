name: Announce Issue on Discord

on:
  issues:
    types: [opened]

jobs:
  announce:
    runs-on: ubuntu-latest
    steps:
      - name: Announce new issue to Discord
        shell: bash
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_AUTHOR: ${{ github.event.issue.user.login }}
          ISSUE_URL: ${{ github.event.issue.html_url }}
        run: |
          set -euo pipefail

          payload=$(python3 - <<'PY'
          import json
          import os

          issue_number = os.environ["ISSUE_NUMBER"]
          issue_title = os.environ["ISSUE_TITLE"]
          issue_author = os.environ["ISSUE_AUTHOR"]
          issue_url = os.environ["ISSUE_URL"]

          content = f"New issue #{issue_number} *opened* by {issue_author}: **{issue_title}**"
          body = {
              "content": content,
              "embeds": [
                  {
                      "description": f"[View Issue]({issue_url})",
                      "color": 11771355,
                      "fields": [
                          {"name": "Author", "value": issue_author, "inline": True},
                      ],
                  }
              ],
          }

          print(json.dumps(body, ensure_ascii=False))
          PY
          )

          curl -H "Content-Type: application/json" -X POST --data "$payload" "$DISCORD_WEBHOOK"
